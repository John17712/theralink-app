<!DOCTYPE html>
<html lang="{{ lang|default('en') }}">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title data-i18n="chat_title">Theralink ‚Äî Chat</title>
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/logo.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='chat.css') }}">
</head>
<body>

<!-- Navbar -->
<nav class="navbar">
  <div class="nav-left">
    <!-- Menu button -->
    <button class="menu-btn" id="menuBtn">‚ò∞</button>

    <!-- Brand -->
    <a href="{{ url_for('dashboard') }}" class="brand-link">
      <img src="{{ url_for('static', filename='img/logo.png') }}" alt="TheraLink Logo" class="logo-img">
      <span class="brand-name">TheraLink</span>
    </a>
  </div>

  <!-- Right: language selector -->
  <div class="nav-right">
    <select id="languageSelector" class="language-selector">
      <option value="en">English</option><option value="es">Espa√±ol</option><option value="fr">Fran√ßais</option>
      <option value="sw">Swahili</option><option value="de">Deutsch</option><option value="it">Italiano</option>
      <option value="pt">Portugu√™s</option><option value="zh">‰∏≠Êñá</option><option value="ja">Êó•Êú¨Ë™û</option>
      <option value="ko">ÌïúÍµ≠Ïñ¥</option><option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä</option><option value="ru">–†—É—Å—Å–∫–∏–π</option>
      <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option><option value="zu">isiZulu</option>
    </select>
  </div>
</nav>

<!-- Layout -->
<div class="wrapper">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <!-- Navigation links -->
    <nav class="sidebar-nav">
      <a href="/dashboard" class="nav-item" data-i18n="nav_home">Home</a>
      <a href="/chat_page" class="nav-item active" data-i18n="nav_chat">Chat</a>
      <a href="/call_page" class="nav-item" data-i18n="nav_call">Call</a>
    </nav>

    <hr style="border: 0; border-top: 1px solid rgba(0,255,159,0.2); margin: 10px 0;">

    <!-- Chat sessions -->
    <h2 data-i18n="chat_sessions">Chat Sessions</h2>
    <ul id="sessionList" class="session-list"></ul>
    <button id="newSessionBtn" type="button" class="new-session-btn" data-i18n="new_session">+ New Session</button>
  </aside>

  <!-- Main chat -->
  <main class="main">
    <div class="header">
      <h1 data-i18n="chat_mode">Chat Mode</h1>
    </div>

    <div id="chatBox" class="transcript">
      <p class="transcript-placeholder" data-i18n="chat_transcript_placeholder">
        Messages will appear here once the session begins.
      </p>
    </div>

    <div class="input-row">
      <textarea id="messageInput"
                data-i18n-placeholder="chat_placeholder"
                placeholder="Type your message..."></textarea>
      <button id="sendBtn" data-i18n="send_btn">Send</button>
    </div>
  </main>
</div>

<!-- Overlay -->
<div class="overlay" id="overlay"></div>

<script>
const menuBtn = document.getElementById("menuBtn");
const sidebar = document.getElementById("sidebar");
const overlay = document.getElementById("overlay");

// Toggle sidebar + overlay
menuBtn.addEventListener("click", () => {
  sidebar.classList.toggle("show");
  overlay.classList.toggle("show");
});

// Close sidebar when clicking overlay
overlay.addEventListener("click", () => {
  sidebar.classList.remove("show");
  overlay.classList.remove("show");
});


  // Language selector
  const languageSelector = document.getElementById('languageSelector');
  const savedLang = localStorage.getItem('selectedLanguage') || '{{ lang|default("en") }}';
  languageSelector.value = savedLang;

  async function loadLanguage(lang) {
    try {
      const res = await fetch(`/static/lang/${lang}.json`);
      if (!res.ok) throw new Error("Could not load translations");
      const dict = await res.json();

      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (dict[key]) el.textContent = dict[key];
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (dict[key]) el.setAttribute("placeholder", dict[key]);
      });

      document.body.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
      localStorage.setItem('selectedLanguage', lang);
    } catch (err) {
      console.error("Error loading language:", err);
    }
  }

  languageSelector.addEventListener('change', function () {
    loadLanguage(this.value);
  });

  loadLanguage(savedLang);
</script>

<script>
// ===== Elements =====
const sessionList = document.getElementById("sessionList");
const newSessionBtn = document.getElementById("newSessionBtn");
const chatBox = document.getElementById("chatBox");
const messageInput = document.getElementById("messageInput");
const sendBtn = document.getElementById("sendBtn");

let sessions = [];
let activeSession = null;

/* ---------- Load Sessions from DB ---------- */
async function loadSessions() {
  try {
    const res = await fetch("/sessions/chat");   // üîπ only chat sessions
    const data = await res.json();
    if (data.success) {
      sessions = data.sessions;
      sessionList.innerHTML = "";
      sessions.forEach(s => renderSession(s));

      // ‚úÖ Check for last active session in localStorage
      const lastActiveId = localStorage.getItem("activeSessionId");
      if (lastActiveId && sessions.find(s => s.session_id === lastActiveId)) {
        loadSession(lastActiveId); // Restore last session
      } else if (sessions.length > 0) {
        const last = sessions[sessions.length - 1];
        loadSession(last.session_id);
        localStorage.setItem("activeSessionId", last.session_id);
      } else {
        activeSession = null;
        chatBox.innerHTML = `<p class="transcript-placeholder">Please create a new session to begin.</p>`;
        localStorage.removeItem("activeSessionId");
      }
    }
  } catch (err) {
    console.error("Error loading sessions:", err);
  }
}



/* ---------- Save Session to DB ---------- */
async function saveSession(session) {
  try {
    await fetch("/sessions/save", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include", // üîπ keep consistent with call
      body: JSON.stringify({
        session_id: session.session_id,
        name: session.name || "Session",
        messages: session.messages || [],
        kind: "chat"  // üîπ force chat kind
      }),
    });
  } catch (err) {
    console.error("Error saving session:", err);
  }
}

/* ---------- Delete Session ---------- */
async function deleteSession(sessionId) {
  if (!confirm("Delete this session?")) return;

  try {
    await fetch("/sessions/delete", {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ session_id: sessionId }),
    });

    // üîπ Remove locally
    sessions = sessions.filter(s => s.session_id !== sessionId);
    document.querySelector(`[data-id="${sessionId}"]`)?.remove();

    // üîπ Reset active if needed
    if (activeSession?.session_id === sessionId) {
      activeSession = null;
      chatBox.innerHTML = `<p class="transcript-placeholder">
        Please create a new session to begin.
      </p>`;
      localStorage.removeItem("activeSessionId");
    }

    // üîπ Notify dashboard to refresh recents if open
    if (window.opener && !window.opener.closed) {
      try {
        window.opener.postMessage({ type: "refreshSessions" }, "*");
      } catch (_) {
        console.warn("Could not notify dashboard to refresh sessions");
      }
    }

  } catch (err) {
    console.error("Error deleting session:", err);
  }
}



/* ---------- Create Session ---------- */
function createSession() {
  const sessionId = `session-${Date.now()}`;
  const session = {
    session_id: sessionId,
    name: `Session ${sessions.length + 1}`,
    messages: [],
    kind: "chat",
  };
  sessions.push(session);
  renderSession(session);
  loadSession(sessionId);
  saveSession(session);
}

/* ---------- Render Sidebar Item ---------- */
function renderSession(session) {
  if (document.querySelector(`[data-id="${session.session_id}"]`)) return;

  const li = document.createElement("li");
  li.className = "session-item";
  li.dataset.id = session.session_id;

  li.innerHTML = `
    <span class="session-title">${session.name}</span>
    <div class="session-actions">
      <button class="menu-btn">‚ãÆ</button>
      <div class="menu-dropdown hidden">
        <button class="rename-btn">Rename</button>
        <button class="delete-btn">Delete</button>
      </div>
    </div>
  `;

  // Load session
  li.querySelector(".session-title").addEventListener("click", () => loadSession(session.session_id));

  // Dropdown toggle
  const menuBtn = li.querySelector(".menu-btn");
  const dropdown = li.querySelector(".menu-dropdown");
  menuBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    document.querySelectorAll(".menu-dropdown").forEach(d => d.classList.add("hidden"));
    dropdown.classList.toggle("hidden");
  });

  // Rename
  li.querySelector(".rename-btn").addEventListener("click", () => renameSession(session.session_id));

  // Delete
  li.querySelector(".delete-btn").addEventListener("click", () => deleteSession(session.session_id));

  sessionList.appendChild(li);
}

// Hide menus when clicking outside
document.addEventListener("click", () => {
  document.querySelectorAll(".menu-dropdown").forEach(d => d.classList.add("hidden"));
});

/* ---------- Load Session ---------- */
function loadSession(sessionId) {
  activeSession = sessions.find(s => s.session_id === sessionId);
  if (!activeSession) return;

  // üîπ Remember last active session
  localStorage.setItem("activeSessionId", sessionId);

  // Highlight in sidebar
  document.querySelectorAll(".session-item").forEach(item => item.classList.remove("active"));
  const activeLi = document.querySelector(`[data-id="${sessionId}"]`);
  if (activeLi) activeLi.classList.add("active");

  // Render messages
  chatBox.innerHTML = "";
  if (activeSession.messages.length === 0) {
    chatBox.innerHTML = `<p class="transcript-placeholder">Messages will appear here once the session begins.</p>`;
  } else {
    activeSession.messages.forEach(msg => {
      const div = document.createElement("div");
      div.className = `msg ${msg.sender}`;
      div.textContent = msg.text;
      chatBox.appendChild(div);
    });
  }
  chatBox.scrollTop = chatBox.scrollHeight;
}


/* ---------- Messaging ---------- */
/* ---------- Messaging ---------- */
async function sendMessage() {
  if (!activeSession) {
    alert("Please create a session first.");
    return;
  }

  const text = messageInput.value.trim();
  if (!text) return;

   // üîπ Remove placeholder if it exists
  const placeholder = chatBox.querySelector(".transcript-placeholder");
  if (placeholder) placeholder.remove();
  

  // Add user message
  activeSession.messages.push({ sender: "user", text });

  const div = document.createElement("div");
  div.className = "msg user";
  div.textContent = text;
  chatBox.appendChild(div);

  messageInput.value = "";
  chatBox.scrollTop = chatBox.scrollHeight;

  // Auto-rename session with backend help
  if (activeSession.messages.length === 1) {
    try {
      const res = await fetch("/chat/rename_session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text, language: "en" }),
      });
      const data = await res.json();
      activeSession.name = data.name || "New Session";
      document.querySelector(`[data-id="${activeSession.session_id}"] .session-title`).textContent = activeSession.name;
    } catch (err) {
      console.error("Auto-rename failed:", err);
    }
  }

  // ==== Therapist Reply (realistic via backend) ====
  try {
    const res = await fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        user_id: "frontend-user", // you can replace with current_user.id if injected
        session_id: activeSession.session_id,
        message: text,
        language: "en", // pass UI language if you want multilingual
      }),
    });
    const data = await res.json();

    const reply = { sender: "therapist", text: data.reply };
    activeSession.messages.push(reply);

    const replyDiv = document.createElement("div");
    replyDiv.className = "msg therapist";
    replyDiv.textContent = reply.text;
    chatBox.appendChild(replyDiv);

    chatBox.scrollTop = chatBox.scrollHeight;
    saveSession(activeSession); // persist updated messages
  } catch (err) {
    console.error("Therapist reply error:", err);
    const errorDiv = document.createElement("div");
    errorDiv.className = "msg therapist";
    errorDiv.textContent = "‚ö†Ô∏è Sorry, something went wrong with the therapist reply.";
    chatBox.appendChild(errorDiv);
  }
}


/* ---------- Utilities ---------- */
function renameSession(sessionId) {
  const session = sessions.find(s => s.session_id === sessionId);
  const newTitle = prompt("Enter a new name for this session:", session.name);
  if (newTitle) {
    session.name = newTitle;
    const titleEl = document.querySelector(`[data-id="${sessionId}"] .session-title`);
    if (titleEl) titleEl.textContent = newTitle;
    saveSession(session);
  }
}

/* ---------- Event Listeners ---------- */
newSessionBtn.addEventListener("click", createSession);
sendBtn.addEventListener("click", sendMessage);
messageInput.addEventListener("keypress", (e) => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});


// Load all sessions from DB when page starts
window.addEventListener("DOMContentLoaded", async () => {
  // 1. Load DB sessions
  await loadSessions();

  // 2. Check if dashboard passed a sid
  const params = new URLSearchParams(window.location.search);
  const sid = params.get("sid");

  if (sid) {
    const target = sessions.find(s => s.session_id === sid);
    if (target) {
      loadSession(sid);
      localStorage.setItem("activeSessionId", sid);
      return;
    }
  }

  // 3. Otherwise fallback to last active session
  const lastActiveId = localStorage.getItem("activeSessionId");
  if (lastActiveId && sessions.find(s => s.session_id === lastActiveId)) {
    loadSession(lastActiveId);
  }
});



</script>

<script src="{{ url_for('static', filename='chat.js') }}"></script>

</body>
</html>
